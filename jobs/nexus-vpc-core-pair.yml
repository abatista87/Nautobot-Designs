version: 1

metadata:
  name: "Nexus VPC Core Pair"
  slug: "nexus-vpc-core-pair"
  description: "Generate base NX-OS configs for a Nexus VPC core pair (Core-A and Core-B)."
  tags:
    - "nexus"
    - "vpc"
    - "core"
    - "pair"

variables:
  - name: site_code
    label: "Site Code"
    type: string
    required: true
    help_text: "Short code for the site, e.g. RIV-DC1 or VIS-DC1."

  - name: domain_name
    label: "Domain Name"
    type: string
    required: true
    default: "example.com"

  - name: vpc_domain_id
    label: "VPC Domain ID"
    type: integer
    required: true
    default: 10

  - name: core_a_hostname
    label: "Core-A Hostname"
    type: string
    required: true
    default: "N9K-CORE-A"

  - name: core_a_mgmt_ipv4
    label: "Core-A Management IPv4 Address"
    type: ip_address
    required: true

  - name: core_b_hostname
    label: "Core-B Hostname"
    type: string
    required: true
    default: "N9K-CORE-B"

  - name: core_b_mgmt_ipv4
    label: "Core-B Management IPv4 Address"
    type: ip_address
    required: true

  - name: mgmt_prefix
    label: "Management Prefix Length"
    type: integer
    required: true
    default: 24

  - name: mgmt_gateway
    label: "Management Gateway"
    type: ip_address
    required: true

  - name: vpc_peer_link_po
    label: "VPC Peer-Link Port-Channel ID"
    type: integer
    required: true
    default: 10
    help_text: "Port-channel number for the VPC peer-link (same on both switches)."

  - name: vpc_peer_link_members
    label: "VPC Peer-Link Member Interfaces (Core-A & Core-B)"
    type: string
    required: true
    default: "Ethernet1/1,Ethernet1/2"
    help_text: "Comma-separated list of interfaces present on both cores, e.g. Ethernet1/1,Ethernet1/2."

  - name: stp_root
    label: "STP Root Switch"
    type: choice
    required: true
    default: "core_a"
    choices:
      - value: "core_a"
        label: "Core-A"
      - value: "core_b"
        label: "Core-B"
    help_text: "Which core should be primary STP root."

  - name: enable_nve
    label: "Enable VXLAN/NVE Stub"
    type: boolean
    required: true
    default: false
    help_text: "If true, include a basic VXLAN/NVE skeleton in both configs."

template:
  engine: jinja2
  content: |
    {# -------------------------------------------------------------
       Helper macros so we don't repeat ourselves too much
       ------------------------------------------------------------- #}
    {% macro stp_priority_for(node) -%}
      {%- if stp_root == "core_a" and node == "A" -%}
        4096
      {%- elif stp_root == "core_a" and node == "B" -%}
        8192
      {%- elif stp_root == "core_b" and node == "B" -%}
        4096
      {%- else -%}
        8192
      {%- endif -%}
    {%- endmacro %}

    {% macro vpc_role_priority_for(node) -%}
      {%- if node == "A" -%}
        1
      {%- else -%}
        2
      {%- endif -%}
    {%- endmacro %}

    {% set peer_link_members = vpc_peer_link_members.split(',') %}

    ! ##############################################################
    ! Nexus VPC Core Pair Base Config - {{ site_code }}
    ! Generated by Nautobot Design Builder
    ! ##############################################################

    ! ============================================================
    ! Core-A: {{ core_a_hostname }}
    ! ============================================================

    hostname {{ core_a_hostname }}
    ip domain-name {{ domain_name }}

    feature vpc
    feature lacp
    feature interface-vlan
    feature hsrp
    {% if enable_nve %}
    feature nv overlay
    feature vn-segment-vlan-based
    {% endif %}

    ! --- Management ---
    vrf context management

    interface mgmt0
      vrf member management
      ip address {{ core_a_mgmt_ipv4 }}/{{ mgmt_prefix }}

    ip route 0.0.0.0/0 {{ mgmt_gateway }} vrf management

    ! --- VPC Domain ---
    vpc domain {{ vpc_domain_id }}
      peer-keepalive destination {{ core_b_mgmt_ipv4 }} source {{ core_a_mgmt_ipv4 }} vrf management
      peer-gateway
      auto-recovery
      delay restore 150
      role priority {{ vpc_role_priority_for("A") }}

    ! --- VPC Peer-Link ---
    interface port-channel{{ vpc_peer_link_po }}
      description {{ site_code }} VPC-PEER-LINK TO {{ core_b_hostname }}
      switchport
      switchport mode trunk
      spanning-tree port type network
      vpc peer-link

    {% for iface in peer_link_members %}
    interface {{ iface.strip() }}
      description {{ site_code }} VPC-PEER-LINK MEMBER TO {{ core_b_hostname }}
      switchport
      switchport mode trunk
      channel-group {{ vpc_peer_link_po }} mode active
    {% endfor %}

    ! --- STP ---
    spanning-tree mode rapid-pvst
    spanning-tree vlan 1-4094 priority {{ stp_priority_for("A") }}

    ! Example SVI (copy/customize as needed)
    !interface Vlan10
    !  description {{ site_code }} User VLAN
    !  ip address 10.10.10.1/24
    !  hsrp 10
    !    preempt
    !    priority {% if stp_root == "core_a" %}110{% else %}100{% endif %}
    !    ip 10.10.10.254

    {% if enable_nve %}
    ! --- VXLAN / NVE Skeleton ---
    interface nve1
      no shutdown
      host-reachability protocol bgp
      source-interface loopback1
      ! member vni XXXX
      !   ingress-replication protocol bgp
    {% endif %}

    ! --- AAA / Logging / Misc (add your standards) ---
    !aaa new-model
    !logging server 10.0.0.10 6 use-vrf management
    !ntp server 10.0.0.20 use-vrf management

    end

    ! ============================================================
    ! Core-B: {{ core_b_hostname }}
    ! ============================================================

    hostname {{ core_b_hostname }}
    ip domain-name {{ domain_name }}

    feature vpc
    feature lacp
    feature interface-vlan
    feature hsrp
    {% if enable_nve %}
    feature nv overlay
    feature vn-segment-vlan-based
    {% endif %}

    ! --- Management ---
    vrf context management

    interface mgmt0
      vrf member management
      ip address {{ core_b_mgmt_ipv4 }}/{{ mgmt_prefix }}

    ip route 0.0.0.0/0 {{ mgmt_gateway }} vrf management

    ! --- VPC Domain ---
    vpc domain {{ vpc_domain_id }}
      peer-keepalive destination {{ core_a_mgmt_ipv4 }} source {{ core_b_mgmt_ipv4 }} vrf management
      peer-gateway
      auto-recovery
      delay restore 150
      role priority {{ vpc_role_priority_for("B") }}

    ! --- VPC Peer-Link ---
    interface port-channel{{ vpc_peer_link_po }}
      description {{ site_code }} VPC-PEER-LINK TO {{ core_a_hostname }}
      switchport
      switchport mode trunk
      spanning-tree port type network
      vpc peer-link

    {% for iface in peer_link_members %}
    interface {{ iface.strip() }}
      description {{ site_code }} VPC-PEER-LINK MEMBER TO {{ core_a_hostname }}
      switchport
      switchport mode trunk
      channel-group {{ vpc_peer_link_po }} mode active
    {% endfor %}

    ! --- STP ---
    spanning-tree mode rapid-pvst
    spanning-tree vlan 1-4094 priority {{ stp_priority_for("B") }}

    ! Example SVI (copy/customize as needed)
    !interface Vlan10
    !  description {{ site_code }} User VLAN
    !  ip address 10.10.10.2/24
    !  hsrp 10
    !    preempt
    !    priority {% if stp_root == "core_b" %}110{% else %}100{% endif %}
    !    ip 10.10.10.254

    {% if enable_nve %}
    ! --- VXLAN / NVE Skeleton ---
    interface nve1
      no shutdown
      host-reachability protocol bgp
      source-interface loopback1
      ! member vni XXXX
      !   ingress-replication protocol bgp
    {% endif %}

    ! --- AAA / Logging / Misc (add your standards) ---
    !aaa new-model
    !logging server 10.0.0.10 6 use-vrf management
    !ntp server 10.0.0.20 use-vrf management

    end
